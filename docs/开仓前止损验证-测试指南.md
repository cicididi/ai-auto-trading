# 开仓前止损验证 - 快速测试指南

## 测试目标

验证系统在开仓前强制检查止损距离，并在不符合要求时拒绝开仓。

## 测试前准备

### 1. 确认配置

查看当前策略的止损配置：

```bash
grep -A 5 "scientificStopLoss" src/agents/tradingAgent.ts
```

应该看到类似：

```typescript
scientificStopLoss: {
  enabled: true,
  atrMultiplier: 2.0,
  useSupport: true,
  minDistance: 0.5,   // 最小止损距离 0.5%
  maxDistance: 5.0,   // 最大止损距离 5.0%
}
```

### 2. 启动系统

```bash
npm run dev
# 或
pm2 restart all
```

### 3. 观察日志

```bash
tail -f logs/pm2-out.log | grep -E "步骤|止损|拒绝|开仓"
```

---

## 测试场景

### 场景1：正常开仓（止损距离合理）

**预期行为**：

- ✅ 系统计算止损距离在 0.5% ~ 5.0% 范围内
- ✅ 开仓成功
- ✅ 自动设置止损止盈单

**观察日志**：

```bash
📊 步骤1: 开仓前计算科学止损位...
✅ 科学止损预计算完成:
   计划入场价: 42350.00
   计算止损价: 41720.50
   止损距离: 1.49%
   配置范围: 0.5% ~ 5.0%
✅ 止损距离验证通过: 1.49% 在 [0.5%, 5.0%] 范围内
📊 步骤2: 止损验证通过，继续开仓流程...
```

---

### 场景2：拒绝开仓（止损距离过大）

**预期行为**：

- ❌ 系统检测到止损距离 > 5.0%
- ❌ 拒绝开仓
- ❌ AI代理收到错误信息，不会创建仓位

**观察日志**：

```bash
📊 步骤1: 开仓前计算科学止损位...
✅ 科学止损预计算完成:
   计划入场价: 42350.00
   计算止损价: 39500.00
   止损距离: 6.73%
   配置范围: 0.5% ~ 5.0%
❌ 拒绝开仓: 止损距离 6.73% > 最大允许 5.0%
   原因: 止损过远，单笔风险过大
   建议: 等待市场波动降低，或降低杠杆倍数
```

**验证**：

```bash
# 检查是否没有创建新持仓
sqlite3 .voltagent/trading.db "SELECT * FROM positions WHERE symbol='BTC_USDT';"
```

---

### 场景3：拒绝开仓（止损距离过小）

**预期行为**：

- ❌ 系统检测到止损距离 < 0.5%
- ❌ 拒绝开仓
- ❌ AI代理收到错误信息

**观察日志**：

```bash
📊 步骤1: 开仓前计算科学止损位...
✅ 科学止损预计算完成:
   计划入场价: 42350.00
   计算止损价: 42250.00
   止损距离: 0.24%
   配置范围: 0.5% ~ 5.0%
❌ 拒绝开仓: 止损距离 0.24% < 最小要求 0.5%
   原因: 止损过近，容易被正常波动误触发
   建议: 等待更好的入场时机，或调整策略参数
```

---

### 场景4：实际成交价偏离（滑点处理）

**预期行为**：

- ✅ 开仓前计算止损通过
- ✅ 开仓执行，但实际成交价格略有偏离
- ✅ 系统自动调整止损价格，保持止损距离百分比不变

**观察日志**：

```bash
📊 步骤1: 开仓前计算科学止损位...
✅ 止损距离验证通过: 1.49% 在 [0.5%, 5.0%] 范围内
📊 步骤2: 止损验证通过，继续开仓流程...
📊 步骤3: 根据实际成交价格调整止损止盈...
实际成交价 42380.00 偏离计划价 42350.00，调整止损位...
✅ 止损止盈价格计算完成:
   实际入场价: 42380.00
   止损价: 41749.00 (1.49% 价格距离)
```

---

## 高级测试

### 测试不同波动率市场

#### 高波动市场（ATR > 5%）

```bash
# 预期：止损距离可能超过 maxDistance，系统拒绝开仓
# 观察日志中的 ATR 值和止损距离
```

#### 低波动市场（ATR < 2%）

```bash
# 预期：止损距离可能低于 minDistance，系统拒绝开仓
# 或者止损距离合理，正常开仓
```

---

## 调整配置测试

### 临时修改策略配置

编辑 `src/agents/tradingAgent.ts`：

```typescript
// 测试更严格的止损范围
scientificStopLoss: {
  enabled: true,
  atrMultiplier: 2.0,
  useSupport: true,
  minDistance: 1.0,   // 提高最小距离到 1.0%
  maxDistance: 3.0,   // 降低最大距离到 3.0%
}
```

重启系统：

```bash
pm2 restart all
```

观察开仓拒绝率是否增加。

---

## 故障排查

### 1. 系统未拒绝不合理的止损距离

**可能原因**：

- 科学止损系统未启用
- 配置未生效

**检查**：

```bash
# 检查环境变量
grep ENABLE_SCIENTIFIC_STOP_LOSS .env

# 检查策略是否正确加载
grep -A 10 "scientificStopLoss" src/agents/tradingAgent.ts
```

### 2. 所有开仓都被拒绝

**可能原因**：

- minDistance/maxDistance 配置过于严格
- 当前市场波动率不适合当前策略

**解决**：

```typescript
// 放宽止损距离范围
minDistance: 0.3,
maxDistance: 8.0,
```

### 3. 日志中没有"步骤1"、"步骤2"等信息

**可能原因**：

- 代码未正确加载
- TypeScript 编译未生效

**解决**：

```bash
# 重新编译
npm run build

# 重启系统
pm2 restart all
```

---

## 成功标准

✅ 当止损距离 < minDistance 时，系统拒绝开仓  
✅ 当止损距离 > maxDistance 时，系统拒绝开仓  
✅ 当止损距离在范围内时，系统正常开仓  
✅ 开仓后自动设置止损止盈单  
✅ 实际成交价偏离时，自动调整止损价格  
✅ AI代理能够理解拒绝原因并调整策略  

---

## 实盘监控

### 关键指标

```bash
# 1. 开仓拒绝率
grep "拒绝开仓" logs/pm2-out.log | wc -l

# 2. 成功开仓数
grep "步骤2: 止损验证通过" logs/pm2-out.log | wc -l

# 3. 拒绝原因分布
grep "拒绝开仓" logs/pm2-out.log | grep -oP '止损距离 \K[0-9.]+%' | sort -n

# 4. 实际止损距离分布
grep "止损距离验证通过" logs/pm2-out.log | grep -oP '验证通过: \K[0-9.]+%' | sort -n
```

### 健康检查

- 拒绝率 < 30% → ✅ 配置合理
- 拒绝率 30-50% → ⚠️ 考虑调整配置
- 拒绝率 > 50% → ❌ 配置过于严格，需要放宽范围

---

**最后更新**: 2025-01-XX  
**测试状态**: 等待实盘验证
