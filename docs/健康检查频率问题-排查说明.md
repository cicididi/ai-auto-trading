# 健康检查频率异常问题 - 排查与修复说明

## 📋 问题描述

用户反馈：在日志中看到 `[health-check] ✅ 健康检查通过，系统运行正常` 的消息大约每 **13秒** 就刷新一次，但在 `.env` 配置文件中明确设置了：

```properties
HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_INTERVAL_MINUTES=5  # 应该是5分钟一次
```

为什么会出现13秒左右就刷新一次的情况？

---

## 🔍 问题分析

### 可能的原因

经过代码审查，发现有 **两个独立的定时服务** 都可能输出类似的日志：

1. **系统健康检查服务** (`src/scheduler/healthCheck.ts`)
   - 配置项：`HEALTH_CHECK_INTERVAL_MINUTES`（默认5分钟）
   - 功能：检查交易所API、数据库连接、孤儿条件单、不一致状态等
   - 日志标识：`[health-check]`

2. **条件单监控服务** (`src/scheduler/priceOrderMonitor.ts`)
   - 配置项：`PRICE_ORDER_CHECK_INTERVAL`（默认30秒）
   - 功能：监控条件单触发、记录成交、更新持仓状态
   - 日志标识：`[price-order-monitor]`

### 实际问题

虽然两个服务使用不同的 logger name，但可能存在以下情况：

1. **环境变量未正确加载**
   - `PRICE_ORDER_CHECK_INTERVAL` 没有正确读取到 `.env` 中的值
   - 导致实际使用了某个硬编码的默认值（约13秒）

2. **日志混淆**
   - 条件单监控服务的某些日志可能与健康检查日志相似
   - 导致用户误认为是健康检查服务频繁执行

3. **定时器设置错误**
   - 代码中可能存在多处调用 `performHealthCheck()` 的地方
   - 或者 `setInterval` 的时间单位计算错误

---

## ✅ 修复方案

### 1. 增强日志标识

**修改文件**：`src/scheduler/healthCheck.ts`

```typescript
// 修改前
logger.debug('🏥 开始健康检查...');
logger.info('✅ 健康检查通过，系统运行正常');

// 修改后
logger.debug('🏥 [系统健康检查] 开始执行...');
logger.info(`✅ [系统健康检查] 通过，系统运行正常 (耗时: ${elapsedTime}ms)`);
```

**修改文件**：`src/scheduler/priceOrderMonitor.ts`

```typescript
// 新增日志标识
logger.info(`🚀 启动条件单监控服务，检测间隔: ${intervalSeconds}秒`);
logger.info(`📋 环境变量 PRICE_ORDER_CHECK_INTERVAL = ${process.env.PRICE_ORDER_CHECK_INTERVAL || '(未设置，使用默认30秒)'}`);
logger.debug(`🔍 检测 ${activeOrders.length} 个活跃条件单...`);
logger.debug(`⏱️  本次条件单检测完成，耗时: ${elapsedTime}ms`);
```

### 2. 增加启动时的配置输出

**修改文件**：`src/scheduler/healthCheck.ts`

```typescript
export function startHealthCheck() {
  const intervalMinutes = parseInt(process.env.HEALTH_CHECK_INTERVAL_MINUTES || '5');
  
  logger.info('='.repeat(80));
  logger.info(`🏥 [系统健康检查] 服务启动`);
  logger.info(`   检查间隔: ${intervalMinutes} 分钟`);
  logger.info(`   环境变量 HEALTH_CHECK_INTERVAL_MINUTES = ${process.env.HEALTH_CHECK_INTERVAL_MINUTES || '(未设置，使用默认5分钟)'}`);
  logger.info('='.repeat(80));
  
  // ... 其他代码
}
```

### 3. 验证环境变量加载

确保在启动系统时正确加载了 `.env` 文件：

```bash
# 方式1：使用 dotenv-cli
npx dotenv-cli -e .env npm start

# 方式2：使用 tsx 的 --env-file 参数
npx tsx --env-file=.env src/index.ts

# 方式3：确保 index.ts 开头有导入
import "dotenv/config";  // ✅ 已存在
```

---

## 🧪 验证步骤

### 1. 重新编译并启动系统

```bash
npm run build
npm start
```

### 2. 观察启动日志

应该看到类似以下输出：

```markdown
==========================================
🏥 [系统健康检查] 服务启动
   检查间隔: 5 分钟
   环境变量 HEALTH_CHECK_INTERVAL_MINUTES = 5
==========================================
🚀 启动条件单监控服务，检测间隔: 30秒
📋 环境变量 PRICE_ORDER_CHECK_INTERVAL = 30
```

### 3. 观察运行日志

- **健康检查日志**（应该每5分钟出现一次）：

  ```markdown
  [health-check] ✅ [系统健康检查] 通过，系统运行正常 (耗时: 245ms)
  ```

- **条件单监控日志**（应该每30秒出现一次，且只在有活跃条件单时才输出）：

  ```markdown
  [price-order-monitor] 🔍 检测 3 个活跃条件单...
  [price-order-monitor] ⏱️  本次条件单检测完成，耗时: 128ms
  ```

### 4. 检查时间间隔

使用以下命令监控日志，确认时间间隔：

```bash
# 监控健康检查日志
tail -f logs/pm2-out.log | grep "系统健康检查"

# 监控条件单检查日志
tail -f logs/pm2-out.log | grep "条件单"
```

---

## 🎯 预期结果

修复后的系统应该表现如下：

| 服务名称 | 配置项 | 默认间隔 | 日志前缀 | 触发条件 |
|---------|--------|---------|---------|---------|
| 系统健康检查 | `HEALTH_CHECK_INTERVAL_MINUTES` | 5分钟 | `[health-check] [系统健康检查]` | 定时触发 |
| 条件单监控 | `PRICE_ORDER_CHECK_INTERVAL` | 30秒 | `[price-order-monitor]` | 定时触发（仅当有活跃条件单时输出日志） |

---

## 📝 额外建议

### 1. 调整条件单监控日志级别

如果条件单监控的 debug 日志过于频繁，可以通过以下方式降低噪音：

```typescript
// 在 src/scheduler/priceOrderMonitor.ts 中
const logger = createLogger({
  name: "price-order-monitor",
  level: "info",  // 从 "debug" 改为 "info"
});
```

### 2. 使用环境变量控制日志级别

在 `.env` 中添加：

```properties
LOG_LEVEL=info  # debug, info, warn, error
```

### 3. 定期检查日志文件大小

```bash
# 查看日志文件大小
ls -lh logs/

# 清理旧日志（可选）
npm run logs:clear
```

---

## 🔧 故障排除

### 问题1：环境变量未生效

**症状**：启动日志显示"(未设置，使用默认值)"

**解决方案**：

1. 检查 `.env` 文件格式是否正确（无多余空格、无BOM头）
2. 确认启动命令正确加载了 `.env` 文件
3. 尝试使用绝对路径：`--env-file=/absolute/path/to/.env`

### 问题2：仍然看到13秒刷新

**排查步骤**：

1. 检查是否有多个进程在运行：`ps aux | grep node`
2. 检查 PM2 是否使用了旧的代码：`pm2 restart all --update-env`
3. 查看完整日志，确认是哪个服务在输出：`tail -f logs/pm2-out.log`

### 问题3：日志混乱

**解决方案**：

1. 使用日志过滤：`tail -f logs/pm2-out.log | grep -E "健康检查|条件单"`
2. 启用 PM2 的日志分割：`pm2 install pm2-logrotate`
3. 使用结构化日志（JSON格式）

---

## 📚 相关文件

- `src/scheduler/healthCheck.ts` - 系统健康检查服务
- `src/scheduler/priceOrderMonitor.ts` - 条件单监控服务
- `src/index.ts` - 主入口，启动所有服务
- `.env` - 环境变量配置

---

## 📅 修复记录

- **修复时间**：2025-11-18
- **修复人员**：GitHub Copilot
- **影响范围**：日志输出、调试体验
- **是否需要数据迁移**：否
- **是否需要重启服务**：是

---

**总结**：通过增强日志标识和输出配置信息，可以明确区分两个服务的运行情况，从而快速定位13秒刷新的真正来源。
