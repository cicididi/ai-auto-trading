# API 请求频率优化说明

## 问题描述

系统在使用交易所API时,可能遇到以下问题:

1. **网络不稳定**: 频繁的 `fetch failed` 错误
2. **频率限制**: 触发交易所的速率限制(如币安的-1003错误)
3. **级联失败**: 网络检查本身也会触发API调用,导致问题加剧

## 优化方案

### 1. 熔断器机制 (Circuit Breaker) ⭐ 新增

当API连续失败达到阈值时,自动触发熔断器:

- **触发条件**: 连续失败3次
- **熔断时长**: 60秒
- **降级策略**: 使用缓存数据(即使过期)
- **自动恢复**: 60秒后自动尝试恢复连接

**工作原理**:

```markdown
正常请求 → 失败1次 → 失败2次 → 失败3次 → 触发熔断器
                                         ↓
                                    暂停API调用
                                         ↓
                                    使用缓存降级
                                         ↓
                                    60秒后自动恢复
```

### 2. 数据缓存机制

为高频访问的数据添加缓存，减少实际API调用：

#### 币安和Gate.io (统一策略)

- **持仓数据缓存**：3秒有效期
- **账户信息缓存**：5秒有效期  
- **行情数据缓存**：2秒有效期
- **K线数据缓存**：30秒有效期

### 3. 缓存降级策略 ⭐ 增强

在以下情况下自动使用缓存数据:

1. **熔断器打开**: 直接返回缓存(即使过期)
2. **API请求失败**: 优先返回缓存而非抛出错误
3. **正常缓存**: 缓存未过期时直接使用

**降级优先级**:

```markdown
有效缓存 > 过期缓存(熔断时) > 过期缓存(失败时) > 抛出错误
```

### 4. 请求限流机制(仅币安)

- 最大请求频率：5500次/分钟（币安限制6000，保留安全边界）
- 最小请求间隔：100ms
- 自动等待机制：达到限制时自动延迟

### 5. 缓存失效策略

在执行会改变状态的操作后自动清除相关缓存：

- 下单成功后：清除持仓和账户缓存
- 取消订单后：清除持仓和账户缓存
- 确保数据一致性

## 实现细节

### 熔断器状态追踪

```typescript
{
  consecutiveFailures: number,    // 连续失败次数
  circuitBreakerOpenUntil: number // 熔断器开启截止时间
}
```

### 缓存数据结构

```typescript
{
  data: T,           // 缓存的数据
  timestamp: number  // 缓存时间戳
}
```

### 限流算法（币安）

1. 记录最近1分钟内的所有请求时间戳
2. 每次请求前检查1分钟内请求数是否超限
3. 如超限，计算需要等待的时间并延迟
4. 确保每次请求间隔至少100ms

## 性能提升

### 预期效果

- **API调用减少**：70-80%（基于缓存命中率）
- **响应速度提升**：缓存命中时接近0延迟
- **避免封禁**：请求频率始终低于限制
- **故障容错**：网络不稳定时仍可正常运行 ⭐ 新增

### 适用场景

- 健康检查服务：每5分钟检查一次，大量使用缓存
- 条件单监控：高频检查持仓状态，缓存显著减少请求
- 交易循环：多次查询同一数据，缓存提高效率
- 网络不稳定：熔断器保护，使用缓存降级 ⭐ 新增

## 兼容性

### 两个交易所统一优化

- 币安和Gate.io都实现了相同的缓存和熔断器策略
- 接口保持不变，业务代码无需修改
- 自动适配不同交易所的特性

### 向后兼容

- 所有接口签名保持不变
- 缓存和熔断器机制对调用方透明
- 不影响现有功能

## 注意事项

1. **缓存时效**：根据数据变化频率设置不同的TTL
2. **数据一致性**：状态变更操作后立即清除缓存
3. **熔断器恢复**：自动恢复后会重新尝试API请求
4. **降级数据**：使用缓存降级时会记录警告日志
5. **测试验证**：建议在测试网充分验证后部署到正式网

## 监控建议

在生产环境建议监控：

- 缓存命中率
- API调用频率
- 请求延迟分布
- 限流触发次数
- **熔断器触发次数** ⭐ 新增
- **缓存降级次数** ⭐ 新增

## 故障处理流程

### 网络问题处理

1. **检测**: 连续3次API失败
2. **熔断**: 自动触发熔断器
3. **降级**: 使用缓存数据维持服务
4. **恢复**: 60秒后自动尝试重连
5. **正常化**: 成功后清除失败计数

### 日志说明

- `🚨 连续失败 X 次，触发熔断器`: 熔断器已开启
- `🔄 熔断器恢复，尝试重新连接`: 开始恢复尝试
- `✅ API请求恢复正常`: 已完全恢复
- `熔断器已打开，使用缓存数据`: 降级中
